# Devlog ‚Äî 2026-W02 (PantryPilot)

## Week
- **Week #:** 2026-W02
- **Date range:** January 13-19, 2026
- **Focus theme:** OCR Extraction + Queue System + Line Items Display

## Goals for this week
- [x] Implement OCR extraction using OpenAI GPT-4o Vision
- [x] Set up standalone Redis Queue service for async processing
- [x] Display line items in UI with currency formatting
- [x] Flexible validation for Vietnamese receipts
- [x] Automatic OCR queueing on receipt upload
- [x] MCP tools integration for receipt validation

## What I shipped

### AI/OCR (Agent Service)
- ‚úÖ Migrated from Ollama to **OpenAI GPT-4o Vision** for receipt OCR
- ‚úÖ Enhanced prompts specifically for **Vietnamese receipt extraction** with detailed column mapping
- ‚úÖ Agent service (`apps/agent/`) with `/extract` endpoint
- ‚úÖ Vision service for image-to-text extraction
- ‚úÖ Receipt agent with structured JSON output (metadata + items)
- ‚úÖ Confidence scoring for extracted data

### Queue System (Redis Queue)
- ‚úÖ Created **standalone queue service** (`apps/queue/`) using **Redis Queue (RQ)**
- ‚úÖ Persistent, distributed task queue for OCR processing
- ‚úÖ Worker processes that call Agent service and save results to database
- ‚úÖ Simple queue client for API service (avoids import issues)
- ‚úÖ Automatic retry and failure handling
- ‚úÖ Queue monitoring endpoints (`/receipts/ocr/queue-status`)
- ‚úÖ **Automatic OCR queueing** on single and bulk upload

### API Enhancements
- ‚úÖ New OCR endpoints:
  - `POST /receipts/ocr/process-all` - Queue all pending receipts
  - `GET /receipts/ocr/queue-status` - Check queue statistics
  - `GET /receipts/ocr/job/{job_id}` - Check specific job status
- ‚úÖ Auto-queue receipts for OCR on upload (single + bulk)
- ‚úÖ Added `ocr_status` filter to receipt repository
- ‚úÖ Fixed SQLAlchemy type errors (Column vs Mapped)
- ‚úÖ Fixed PostgreSQL integer overflow (changed default `last_id` from sys.maxsize to -1)

### UI Improvements (Streamlit)
- ‚úÖ Display **line items** when `ocr_status = completed`
- ‚úÖ Currency formatting for Vietnamese Dong (VND)
- ‚úÖ Upload notifications with success/error messages
- ‚úÖ Better receipt detail view with merchant, date, total
- ‚úÖ Line items table with quantity, price, total

### Validation & Error Handling
- ‚úÖ Relaxed validation to **50% tolerance** (prices are not main target)
- ‚úÖ Most validation errors downgraded to **warnings** instead of failures
- ‚úÖ Negative price support for discounts/promotions
- ‚úÖ Flexible field extraction (focus on item names, not perfect prices)

### Infrastructure
- ‚úÖ Added **Redis** to docker-compose
- ‚úÖ Queue worker service in docker-compose
- ‚úÖ macOS fork() safety fix (`OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`)
- ‚úÖ Environment variable configuration for local vs Docker

## Demo
- **How to run:**
  ```bash
  # 1. Start infrastructure
  docker-compose up -d postgres minio redis
  
  # 2. Start API
  cd apps/api && uvicorn app.main:app --reload --port 8000
  
  # 3. Start Agent
  cd apps/agent && uvicorn app.main:app --reload --port 8002
  
  # 4. Start Queue Worker (macOS)
  export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
  PYTHONPATH=apps/queue rq worker pantry-pilot --url redis://localhost:6379 -v
  
  # 5. Start Web UI
  cd apps/web && streamlit run app/main.py
  
  # 6. Upload receipts and watch queue process them
  curl -X POST "http://localhost:8000/receipts/ocr/process-all?user_id=1&limit=5"
  ```

## Technical notes (important decisions)

- **Decision:** Switched from Ollama to OpenAI GPT-4o Vision  
  **Why:** Better Vietnamese text recognition, more reliable structured output, faster processing  
  **Alternatives considered:** Keep Ollama (struggled with Vietnamese receipts)

- **Decision:** Created standalone queue service instead of inline processing  
  **Why:** Reusable across services, persistent queue, distributed workers, better observability  
  **Alternatives considered:** Process OCR inline in API (blocks requests, no retry, limited to single worker)

- **Decision:** Renamed queue package from `app/` to `pantry_queue/`  
  **Why:** Avoid conflicts with Python's built-in `queue` module  
  **Alternatives considered:** Keep `app/` name (caused import errors)

- **Decision:** Use raw SQL in queue workers instead of SQLAlchemy models  
  **Why:** Queue service is separate, doesn't need all API models, simpler dependencies  
  **Alternatives considered:** Import API models (creates tight coupling)

- **Decision:** Relaxed validation to 50% tolerance  
  **Why:** Focus is on item extraction, not perfect price matching; Vietnamese receipts have varied formats  
  **Alternatives considered:** Strict validation (too many false failures)

- **Decision:** Auto-queue OCR on upload  
  **Why:** Better UX - users don't need manual trigger, processing starts immediately  
  **Alternatives considered:** Manual trigger via button (extra step, easy to forget)

## Architecture

### OCR Processing Flow
```
1. User uploads receipt ‚Üí API saves to DB + MinIO
   ‚Üì
2. API enqueues OCR task ‚Üí Redis Queue
   ‚Üì
3. Worker picks up task ‚Üí Calls Agent service
   ‚Üì
4. Agent extracts data with GPT-4o Vision
   ‚Üì
5. Worker saves results ‚Üí Updates receipt + inserts line items
   ‚Üì
6. UI polls for status ‚Üí Displays extracted data
```

### Service Dependencies
```
Web (Streamlit) ‚Üí API (FastAPI) ‚Üí MinIO, Postgres
                                 ‚Üì
                       Redis Queue ‚Üê Queue Worker ‚Üí Agent (GPT-4o)
```

## Metrics
### OCR Performance
- **Success rate:** ~90% for Vietnamese receipts
- **Processing time:** 20-35 seconds per receipt (GPT-4o API call)
- **Queue throughput:** 1 worker = ~2 receipts/minute
- **Item extraction accuracy:** 85-95% (names), 70-80% (prices)

### Queue System
- **Jobs queued:** 100+ receipts processed
- **Failed jobs:** ~10% (mostly API timeouts or malformed receipts)
- **Worker uptime:** Stable with graceful shutdown support
- **Retry rate:** Automatic retry on transient failures

## Bugs / Issues

- üêõ **Bug:** Redis connection refused  
  **Impact:** Queue not working  
  **Root cause:** Redis not started  
  **Fix:** `docker-compose up -d redis`

- üêõ **Bug:** Python name conflict with `queue` package  
  **Impact:** Import errors for queue tasks  
  **Root cause:** Package named `queue` conflicts with built-in module  
  **Fix:** Renamed to `pantry_queue`

- üêõ **Bug:** macOS fork() crash with NSMutableString  
  **Impact:** Worker crashes on job execution  
  **Root cause:** macOS Objective-C runtime doesn't allow fork() after certain calls  
  **Fix:** Set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` environment variable

- üêõ **Bug:** PostgreSQL integer overflow with sys.maxsize  
  **Impact:** Database query fails  
  **Root cause:** sys.maxsize (2^63-1) exceeds PostgreSQL INTEGER max (2^31-1)  
  **Fix:** Changed default `last_id` from sys.maxsize to -1

- üêõ **Bug:** Missing `ocr_status` filter in repository  
  **Impact:** Can't query receipts by OCR status  
  **Root cause:** Filter not implemented in `__get_conditions()`  
  **Fix:** Added ocr_status to filter conditions

- üêõ **Bug:** Column `name` does not exist in receipt_items  
  **Impact:** INSERT query fails  
  **Root cause:** Column is `item_name`, not `name`  
  **Fix:** Updated SQL to use correct column names (item_name, currency, confidence)

- üêõ **Bug:** Invalid date format for PostgreSQL  
  **Impact:** Receipt update fails with date string  
  **Root cause:** Passing string '2026-01-19' instead of date object  
  **Fix:** Added `parse_date()` helper to convert strings to date objects

## What I learned

### Redis Queue (RQ)
- Simple, Pythonic task queue with excellent developer experience
- Better than Celery for simple use cases (less configuration)
- Workers can be scaled horizontally easily
- Built-in retry, failure tracking, and job status

### OpenAI GPT-4o Vision
- Excellent for Vietnamese OCR (better than open-source alternatives)
- Structured output with JSON mode ensures consistent format
- Vision + text capabilities in one API call
- Cost: ~$0.01-0.02 per receipt (acceptable for MVP)

### Queue System Design
- Standalone queue service is better than tight coupling
- Graceful degradation: upload succeeds even if queue fails
- Worker processes should be stateless for easy scaling
- Use raw SQL for workers to avoid heavy dependencies

### Vietnamese Receipt Challenges
- Column-based layout (not table format)
- Mixed units (kg, pcs, g√≥i, b√≥)
- Price variations due to weight (0.246 kg √ó 38,000 = 9,348)
- Promotions show as negative items
- Need flexible validation, not strict rules

## Next steps (W03)
- [ ] Add batch OCR status polling in UI (instead of manual refresh)
- [ ] Improve error messages in UI when OCR fails
- [ ] Add retry button for failed OCR jobs
- [ ] Optimize queue worker for concurrent processing
- [ ] Add queue metrics dashboard (jobs/min, success rate)
- [ ] Implement webhook/websocket for real-time status updates
- [ ] Add receipt search/filter by merchant, date range
- [ ] Export receipts to CSV/Excel

## Time tracking
- **Total time:** ~20 hours
- **Breakdown:**
  - OpenAI GPT-4o integration: 3 hours
  - Queue service design + implementation: 8 hours
  - UI line items + formatting: 2 hours
  - Debugging queue issues: 4 hours
  - Validation improvements: 2 hours
  - Documentation: 1 hour

## Resources
- [Redis Queue Documentation](https://python-rq.org/)
- [OpenAI Vision API](https://platform.openai.com/docs/guides/vision)
- [SQLAlchemy Async Guide](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
