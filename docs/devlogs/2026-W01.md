# Devlog ‚Äî 2026-W01 (PantryPilot)

## Week
- **Week #:** 2026-W01
- **Date range:** January 6-9, 2026
- **Focus theme:** Receipt upload + storage + DB skeleton

## Goals for this week
- [x] Boot full stack with docker compose
- [x] Upload receipt image ‚Üí MinIO
- [x] Save receipts metadata ‚Üí Postgres + show list in Streamlit
- [x] API docs + sample request/response

## What I shipped
### UI (Streamlit)
- ‚úÖ Restructured app into modular components (header, footer) and views (upload, bulk_upload, receipts_list)
- ‚úÖ Single receipt upload page with image preview and improved success display (metrics instead of JSON)
- ‚úÖ Bulk upload page supporting multiple file uploads with grid preview
- ‚úÖ Receipts list page with pagination (Previous/Next buttons)
- ‚úÖ Receipt detail view with formatted display and image preview
- ‚úÖ Fixed Streamlit deprecation warnings (use_container_width, use_column_width)
- ‚úÖ Added unique keys to all widgets to prevent duplicate element IDs

### API (FastAPI)
- ‚úÖ Implemented 3-layer architecture: Router ‚Üí Service ‚Üí Repository
- ‚úÖ Receipt endpoints: POST /, POST /bulk, GET /, GET /{id}
- ‚úÖ Pagination support with cursor-based approach (last_id, limit)
- ‚úÖ Bulk upload endpoint accepting List[UploadFile]
- ‚úÖ Health check endpoint
- ‚úÖ Proper error handling with 404 for missing receipts, 201 for creation
- ‚úÖ MinIO integration for receipt image storage
- ‚úÖ Fixed import paths (api.app ‚Üí app)

### Data/Infra
- ‚úÖ PostgreSQL with async SQLAlchemy 2.0 (AsyncSession, asyncpg)
- ‚úÖ Fixed database models (corrected __tablename__ typo in Users model)
- ‚úÖ Repository pattern with save(), save_many(), get_by_id(), get_all() methods
- ‚úÖ MinIO S3-compatible object storage for receipt images
- ‚úÖ Migrated from requirements.txt to pyproject.toml with uv workspace
- ‚úÖ Comprehensive test suite with pytest-asyncio for all layers (repository, service, router)
- ‚úÖ SQLite in-memory database for testing with proper async fixtures  

## Demo
- **Screenshots/GIFs:** (add screenshots)
- **How to run the demo:**
  1. `docker compose up` to start PostgreSQL and MinIO
  2. `cd apps/api && uvicorn app.main:app --reload` for API
  3. `cd apps/web && streamlit run app/main.py` for UI
  4. Upload single/multiple receipts and view list with pagination

## Technical notes (important decisions)
- **Decision:** Implemented 3-layer architecture (Router ‚Üí Service ‚Üí Repository)  
  **Why:** Separates concerns, makes testing easier, follows clean architecture principles  
  **Alternatives considered:** Simple CRUD in routers (would become unmaintainable)

- **Decision:** Cursor-based pagination with last_id instead of offset  
  **Why:** More efficient for large datasets, handles concurrent inserts better  
  **Alternatives considered:** OFFSET/LIMIT (has performance issues with large offsets)

- **Decision:** Renamed `pages/` directory to `views/` in Streamlit app  
  **Why:** Streamlit auto-generates multi-page navigation from `pages/` directory, conflicting with our tab-based design  
  **Alternatives considered:** Keep pages/ and use Streamlit's built-in navigation (didn't match our UX intent)

- **Decision:** Used pytest-asyncio with SQLite + aiosqlite for testing  
  **Why:** Fast in-memory tests, no need for test database setup, matches async production code  
  **Alternatives considered:** Use PostgreSQL for tests (slower, more setup overhead)  

## Metrics
### Upload/Storage
- **Upload success rate:** 100% (local testing)
- **Avg upload time:** ~200-500ms per receipt (local MinIO)
- **Bulk upload:** Successfully tested with 5+ files simultaneously  

## Bugs / Issues
- üêõ **Bug:** ModuleNotFoundError: No module named 'api'  
  **Impact:** API wouldn't start  
  **Root cause:** Incorrect import paths using api.app prefix  
  **Fix:** Changed all imports from api.app.* to app.* (app is package root)

- üêõ **Bug:** SQLAlchemy InvalidRequestError on Users model  
  **Impact:** Database operations failing  
  **Root cause:** Typo __table_name__ instead of __tablename__  
  **Fix:** Corrected to __tablename__

- üêõ **Bug:** pytest async fixture warnings  
  **Impact:** Tests showing deprecation warnings  
  **Root cause:** Using @pytest.fixture instead of @pytest_asyncio.fixture  
  **Fix:** Added @pytest_asyncio.fixture decorator and asyncio_default_fixture_loop_scope

- üêõ **Bug:** Streamlit left sidebar appearing with broken links  
  **Impact:** Confusing UX, non-functional navigation  
  **Root cause:** Streamlit auto-generates pages/ directory into multi-page nav  
  **Fix:** Renamed pages/ to views/

- üêõ **Bug:** Streamlit deprecation warnings for use_container_width and use_column_width  
  **Impact:** Console warnings, future compatibility issues  
  **Root cause:** Deprecated parameters on st.button and st.image  
  **Fix:** Removed deprecated parameters, use Streamlit defaults  

## What I learned
- Python package structure: When app/ is the root package, imports should be from app.*, not api.app.*
- SQLAlchemy is strict about dunder attribute names (__tablename__ not __table_name__)
- pytest-asyncio requires explicit @pytest_asyncio.fixture decorator for async fixtures in newer versions
- Streamlit automatically converts pages/ directory into multi-page navigation, use different name for component modules
- Streamlit widget parameters vary by widget type (use_column_width only for images, not buttons)
- Cursor-based pagination is more robust than offset-based for real-world apps
- 3-layer architecture makes testing much easier with proper mocking at each layer  

## What I didn‚Äôt finish (and why)
- OCR integration - focused on core upload/storage infrastructure first
- User authentication - using hardcoded user_id=1 for now to simplify testing
- Error handling for MinIO failures - need to add retry logic and better error messages
- Progress indicators for bulk uploads - would improve UX for large batches

## Next week plan
- [ ] Start W02: OCR + parse + review/edit UI
- [ ] Implement receipt OCR with extraction of key fields (date, total, merchant)
- [ ] Add review/edit UI for correcting OCR results
- [ ] User authentication and proper user context
