# Plan — 2026-W02

## Theme
Week 2 — LLM Agent for Receipt Extraction + Review/Edit UI

## Goals (3–6)
- [ ] Set up LLM agent (Gemma-3n) with MCP tools for receipt extraction
- [ ] Implement vision preprocessing pipeline (image → text)
- [ ] Create MCP tools for structured data extraction
- [ ] Store parsed data in database (merchant, date, total, items)
- [ ] Build review/edit UI in Streamlit for correcting agent results
- [ ] Add validation rules for extracted fields
- [ ] Improve error handling for extraction failures

## Tasks

### ML/OCR
- [ ] Set up LLM Agent infrastructure:
  - [ ] Install Gemma-3n model (multimodal vision model)
  - [ ] Set up MCP (Model Context Protocol) server
  - [ ] Configure agent with system prompt for receipt extraction
- [ ] Vision preprocessing pipeline:
  - [ ] Image enhancement (contrast, rotation, denoising)
  - [ ] OCR fallback (Tesseract for text extraction if needed)
  - [ ] Image format conversion and resizing
- [ ] Implement MCP Tools:
  - [ ] `extract_receipt_metadata` - merchant, date, total
  - [ ] `extract_line_items` - individual products
  - [ ] `categorize_item` - assign food categories
  - [ ] `estimate_expiration_date` - predict shelf life
  - [ ] `validate_extraction` - business rule validation
  - [ ] `save_receipt_to_database` - persist data
- [ ] Agent workflow:
  - [ ] Receive image → extract metadata → extract items → categorize → validate → save
  - [ ] Retry logic for low-confidence extractions
  - [ ] Error handling for tool failures
- [ ] Add tests for agent and tools

### Database
- [ ] Extend `receipts` table:
  - [ ] Add `ocr_text` column (TEXT, nullable) for raw OCR output
  - [ ] Add `merchant_name` column (VARCHAR, nullable)
  - [ ] Add `total_amount` column (DECIMAL, nullable)
  - [ ] Add `currency` column (VARCHAR(3), default 'USD')
  - [ ] Add `ocr_status` column (ENUM: 'pending', 'processing', 'completed', 'failed')
  - [ ] Add `parsed_at` timestamp
- [ ] Create migration script with Alembic
- [ ] Optional: Create `receipt_items` table for line items:
  - [ ] `id`, `receipt_id`, `item_name`, `quantity`, `unit_price`, `total_price`

### API (FastAPI)
- [ ] Update receipt upload endpoint:
  - [ ] Trigger OCR processing after image upload
  - [ ] Option: async task queue (Celery/RQ) or simple background task
  - [ ] Update receipt status to 'processing'
- [ ] New endpoints:
  - [ ] `POST /receipts/{id}/ocr` — manually trigger OCR reprocessing
  - [ ] `PATCH /receipts/{id}` — update parsed fields (merchant, total, etc.)
  - [ ] `GET /receipts/{id}/ocr-status` — check OCR processing status
- [ ] Add validation:
  - [ ] Merchant name: max length, no special chars
  - [ ] Total amount: positive number, 2 decimal places
  - [ ] Date: valid date format, not future date
- [ ] Error handling:
  - [ ] OCR timeout (set max processing time)
  - [ ] Invalid image format
  - [ ] OCR service unavailable
- [ ] Update response models to include parsed fields

### UI (Streamlit)
- [ ] Receipt detail view enhancements:
  - [ ] Show OCR status badge ('Processing', 'Completed', 'Failed')
  - [ ] Display extracted text in collapsible section
  - [ ] Show parsed fields (merchant, date, total) in editable form
- [ ] Review/Edit screen:
  - [ ] Form fields for merchant, date, total
  - [ ] Side-by-side: original image + extracted data
  - [ ] Save/Update button to persist changes
  - [ ] Validation feedback (inline errors)
- [ ] Receipts list improvements:
  - [ ] Show merchant name and total in list view
  - [ ] Filter by OCR status
  - [ ] Sort by date, merchant, amount
- [ ] Error handling UI:
  - [ ] Show OCR failures with retry button
  - [ ] Display helpful error messages

### Testing
- [ ] Unit tests for OCR service
- [ ] Unit tests for receipt parser (regex patterns)
- [ ] Integration tests for OCR endpoint
- [ ] Test edge cases:
  - [ ] Blurry/low-quality images
  - [ ] Non-English receipts (if supporting)
  - [ ] Images with no text
  - [ ] Very long receipts

### DevOps/Infra
- [ ] Add LLM and MCP dependencies to pyproject.toml:
  - [ ] Gemma model dependencies
  - [ ] MCP server library (fastmcp or custom)
  - [ ] Vision preprocessing libraries (pillow, opencv-python)
  - [ ] python-dateutil for date parsing
- [ ] Update docker-compose:
  - [ ] Add MCP server container (optional - can run in same container as API)
  - [ ] Mount models directory for Gemma weights
  - [ ] Configure GPU support if available
- [ ] Add environment variables for agent config:
  - [ ] Model path, temperature, max tokens
  - [ ] Confidence thresholds
  - [ ] Tool timeout settings
- [ ] Update CI/CD:
  - [ ] Add MCP tool tests
  - [ ] Mock LLM responses for fast testing
  - [ ] Integration tests with sample receipts

## Demo Checklist
- [ ] Upload a receipt → see "Processing" status
- [ ] Wait for OCR completion → status changes to "Completed"
- [ ] View receipt details → see extracted merchant, date, total
- [ ] Edit incorrect fields → save changes successfully
- [ ] Upload blurry image → graceful failure with error message
- [ ] Receipts list shows merchant and total columns

## Technical Decisions to Make
1. **LLM Agent Approach (DECIDED):**
   - ✅ Use Gemma-3n multimodal vision model
   - ✅ MCP (Model Context Protocol) for tool calling
   - **Why:** More robust than regex, handles unstructured receipts, extensible
   - **Alternative:** Traditional OCR + regex (too brittle)

2. **MCP Server Deployment:**
   - Same container as API: Simpler, shared dependencies
   - Separate service: Better isolation, can scale independently
   - **Recommendation:** Start with same container, separate later if needed

3. **Vision Preprocessing:**
   - Basic: Just pass image to Gemma (simple, but may miss details)
   - Enhanced: Rotate, enhance contrast, denoise (better accuracy)
   - **Recommendation:** Start basic, add enhancements if accuracy < 80%

4. **Extraction Strategy:**
   - Single-pass: Agent extracts everything in one call (fast, may miss details)
   - Multi-pass: Metadata → Items → Categories → Validation (more accurate)
   - **Recommendation:** Multi-pass with MCP tools for better accuracy and debugging

5. **Line Items vs Summary:**
   - Parse line items in Week 2: More complex, higher value, enables pantry tracking
   - Skip for now: Focus on merchant/date/total only
   - **Recommendation:** Implement line items - core feature for pantry management

6. **Confidence Handling:**
   - Auto-save high confidence (>0.85): Fast UX
   - Always review: Safer but slower
   - **Recommendation:** Auto-save >0.85, flag <0.70 for manual review

## Metrics to Track
- **OCR Accuracy:** % of receipts with correctly extracted total (manual validation)
- **Processing Time:** Average time from upload to OCR completion
- **Error Rate:** % of receipts that fail OCR processing
- **User Corrections:** % of receipts where user edits parsed fields

## Risks & Mitigation
- **Risk:** OCR accuracy too low on real receipts
  - **Mitigation:** Start with high-quality test images, add pre-processing (rotation, contrast)
  
- **Risk:** OCR processing too slow (>30s per receipt)
  - **Mitigation:** Add background task queue, show progress indicator
  
- **Risk:** Regex parsing too brittle (breaks on different receipt formats)
  - **Mitigation:** Collect failed examples, iteratively improve patterns
  
- **Risk:** Cloud OCR costs too high
  - **Mitigation:** Start with Tesseract (free), only upgrade if accuracy requires it

## Stretch Goals (if time permits)
- [ ] Support for multiple currencies
- [ ] Automatic merchant logo/icon detection
- [ ] Receipt quality score (warn user if image too blurry)
- [ ] Batch OCR reprocessing for failed receipts
- [ ] Export parsed data to CSV/JSON
- [ ] Analytics: spending by merchant, category over time

## Notes
- Keep hardcoded `user_id = 1` for now (auth in W03 or later)
- Focus on core OCR flow: upload → extract → review → save
- Don't over-engineer parsing — simple regex is fine for MVP
- Prioritize good error messages and retry mechanisms
