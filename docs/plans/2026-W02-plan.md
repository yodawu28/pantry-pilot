# Plan — 2026-W02

## Theme
Week 2 — OCR + Receipt Parsing + Review/Edit UI

## Goals (3–6)
- [ ] Integrate OCR to extract text from receipt images
- [ ] Parse extracted text to identify key fields (merchant, date, total, items)
- [ ] Store parsed data in database (new tables/columns)
- [ ] Build review/edit UI in Streamlit for correcting OCR results
- [ ] Add validation rules for parsed fields
- [ ] Improve error handling for upload/OCR failures

## Tasks

### ML/OCR
- [ ] Research OCR options:
  - [ ] Tesseract OCR (free, local)
  - [ ] Google Cloud Vision API (cloud, paid)
  - [ ] Azure Computer Vision (cloud, paid)
  - [ ] AWS Textract (cloud, paid)
- [ ] Implement OCR service:
  - [ ] Create `OCRService` class
  - [ ] Add method to extract text from image
  - [ ] Handle common image formats (jpg, png)
  - [ ] Add error handling for unreadable images
- [ ] Create receipt parser:
  - [ ] Extract merchant name (regex patterns)
  - [ ] Extract purchase date (date parsing)
  - [ ] Extract total amount (currency detection)
  - [ ] Extract line items (if possible)
- [ ] Add tests for OCR and parsing logic

### Database
- [ ] Extend `receipts` table:
  - [ ] Add `ocr_text` column (TEXT, nullable) for raw OCR output
  - [ ] Add `merchant_name` column (VARCHAR, nullable)
  - [ ] Add `total_amount` column (DECIMAL, nullable)
  - [ ] Add `currency` column (VARCHAR(3), default 'USD')
  - [ ] Add `ocr_status` column (ENUM: 'pending', 'processing', 'completed', 'failed')
  - [ ] Add `parsed_at` timestamp
- [ ] Create migration script with Alembic
- [ ] Optional: Create `receipt_items` table for line items:
  - [ ] `id`, `receipt_id`, `item_name`, `quantity`, `unit_price`, `total_price`

### API (FastAPI)
- [ ] Update receipt upload endpoint:
  - [ ] Trigger OCR processing after image upload
  - [ ] Option: async task queue (Celery/RQ) or simple background task
  - [ ] Update receipt status to 'processing'
- [ ] New endpoints:
  - [ ] `POST /receipts/{id}/ocr` — manually trigger OCR reprocessing
  - [ ] `PATCH /receipts/{id}` — update parsed fields (merchant, total, etc.)
  - [ ] `GET /receipts/{id}/ocr-status` — check OCR processing status
- [ ] Add validation:
  - [ ] Merchant name: max length, no special chars
  - [ ] Total amount: positive number, 2 decimal places
  - [ ] Date: valid date format, not future date
- [ ] Error handling:
  - [ ] OCR timeout (set max processing time)
  - [ ] Invalid image format
  - [ ] OCR service unavailable
- [ ] Update response models to include parsed fields

### UI (Streamlit)
- [ ] Receipt detail view enhancements:
  - [ ] Show OCR status badge ('Processing', 'Completed', 'Failed')
  - [ ] Display extracted text in collapsible section
  - [ ] Show parsed fields (merchant, date, total) in editable form
- [ ] Review/Edit screen:
  - [ ] Form fields for merchant, date, total
  - [ ] Side-by-side: original image + extracted data
  - [ ] Save/Update button to persist changes
  - [ ] Validation feedback (inline errors)
- [ ] Receipts list improvements:
  - [ ] Show merchant name and total in list view
  - [ ] Filter by OCR status
  - [ ] Sort by date, merchant, amount
- [ ] Error handling UI:
  - [ ] Show OCR failures with retry button
  - [ ] Display helpful error messages

### Testing
- [ ] Unit tests for OCR service
- [ ] Unit tests for receipt parser (regex patterns)
- [ ] Integration tests for OCR endpoint
- [ ] Test edge cases:
  - [ ] Blurry/low-quality images
  - [ ] Non-English receipts (if supporting)
  - [ ] Images with no text
  - [ ] Very long receipts

### DevOps/Infra
- [ ] Add OCR dependencies to pyproject.toml
  - [ ] pytesseract (if using Tesseract)
  - [ ] pillow for image processing
  - [ ] python-dateutil for date parsing
- [ ] Update docker-compose if needed (Tesseract container?)
- [ ] Add environment variables for OCR config
- [ ] Update CI/CD to run OCR tests (may need test images)

## Demo Checklist
- [ ] Upload a receipt → see "Processing" status
- [ ] Wait for OCR completion → status changes to "Completed"
- [ ] View receipt details → see extracted merchant, date, total
- [ ] Edit incorrect fields → save changes successfully
- [ ] Upload blurry image → graceful failure with error message
- [ ] Receipts list shows merchant and total columns

## Technical Decisions to Make
1. **OCR Provider:**
   - Local (Tesseract): Free, privacy-friendly, but less accurate
   - Cloud (GCP/AWS/Azure): More accurate, costs money, requires API keys
   - **Recommendation:** Start with Tesseract for MVP, easy to swap later

2. **OCR Processing:**
   - Synchronous: Simple, but blocks API request (slow UX)
   - Background task: Better UX, requires task queue setup
   - **Recommendation:** Start synchronous, add background processing if needed

3. **Parsing Strategy:**
   - Regex patterns: Fast, works for structured receipts
   - ML model: More robust, requires training data
   - LLM (GPT/Claude): Very accurate, costs per call
   - **Recommendation:** Start with regex, evaluate LLM for complex cases

4. **Line Items:**
   - Parse line items in Week 2: More complex, higher value
   - Skip for now: Focus on merchant/date/total
   - **Recommendation:** Skip line items for W02, add in W03 if time allows

## Metrics to Track
- **OCR Accuracy:** % of receipts with correctly extracted total (manual validation)
- **Processing Time:** Average time from upload to OCR completion
- **Error Rate:** % of receipts that fail OCR processing
- **User Corrections:** % of receipts where user edits parsed fields

## Risks & Mitigation
- **Risk:** OCR accuracy too low on real receipts
  - **Mitigation:** Start with high-quality test images, add pre-processing (rotation, contrast)
  
- **Risk:** OCR processing too slow (>30s per receipt)
  - **Mitigation:** Add background task queue, show progress indicator
  
- **Risk:** Regex parsing too brittle (breaks on different receipt formats)
  - **Mitigation:** Collect failed examples, iteratively improve patterns
  
- **Risk:** Cloud OCR costs too high
  - **Mitigation:** Start with Tesseract (free), only upgrade if accuracy requires it

## Stretch Goals (if time permits)
- [ ] Support for multiple currencies
- [ ] Automatic merchant logo/icon detection
- [ ] Receipt quality score (warn user if image too blurry)
- [ ] Batch OCR reprocessing for failed receipts
- [ ] Export parsed data to CSV/JSON
- [ ] Analytics: spending by merchant, category over time

## Notes
- Keep hardcoded `user_id = 1` for now (auth in W03 or later)
- Focus on core OCR flow: upload → extract → review → save
- Don't over-engineer parsing — simple regex is fine for MVP
- Prioritize good error messages and retry mechanisms
